---
title: lol
date: 2024-10-12 14:56:42
updated: 2024-10-12 14:56:42
index_img: https://cdn.sxrekord.com/blog/code.jpg
categories:
- 折腾
tags:
- C/C++
---

# 前言

过去写代码的时候一般都是出了问题就加printf，但是随着项目规模的增大，为了避免满屏提示，所以在开发过后会尽可能的删除或注释掉相关printf语句。

然而开发好的程序或模块在日后运行过程中也会渐渐的暴露出越来越隐晦的bug，这时一般会考虑上GDB调试或加printf复现问题（二者使用频率/场景难分伯仲）。

‍

printf的好处在于极其简单，但问题在于不一定能很快定位至相应的错误位置，而每次启停程序+添加/修改printf语句+重新编译耗时也并不很短。

而GDB的好处在于功能强大，但问题在于无法在调试时动态修改代码，所以猜测某部分出现问题后也需要实际修改源代码继而编译后继续gdb。更别说在某些实时环境下gdb会影响问题的复现。

## 为什么不使用日志

显然上述痛点直接的解决方案就是使用日志，或者说日志就是为了解决上述问题。

但我过去没有习惯性的使用日志主要是因为以下几个原因：

1. 有时候负责的部分仅是一个模块，而日志框架常常需要初始化/销毁，而作为一个模块，这部分工作通常不应该交给模块来做，于是日志的付诸使用也就搁置下来。
2. 使用第三方库时，规模稍大一点基本都有自己的日志系统，而不同的日志系统格式化能力和程度是不同的，在这种情况下尽量不想硬塞进自己的另一套日志系统，从而导致输出乱七八糟（强迫症可能会当场去世）？
3. 很多日志框架还远远够不上“easy to use”，有些是因为调用语句过长，有些是因为有一定的状态维护成本。

# 目标

所以我要设计的日志框架首先就是要能克服上述问题。

而设计目标也比较纯粹，就是在实现必要功能的前提下使得它尽可能简单和易用。所以我给它取名为`lol`​，即`Logger fOr Log`​。

其应支持以下特性：

* 基本的日志功能
* 使用简单

  * 调用时不需要传递日志级别，框架本身已经提供了所有相关宏。
  * 没有状态维护成本，整个生命周期仅需要适时的进行一次初始化和销毁。
* 支持日志域，方便区分不同模块
* 支持特定的多线程场景

  * 框架销毁函数（lol_fini())多线程不安全，但可以在单线程中多次调用。
  * 其他函数均支持多线程。

# 设计

将日志域作为一个单向链表，通过域名匹配，匹配到了以后执行对应的格式化要求。

所以初始化/添加域/销毁时内部仅需维护一张链表。

在我实际使用过程中，一般会按模块划分域，所以域的数量不会太多，基本都很难突破个位数。

当然，我也不排除有人将模块划分的粒度定的特别细，或者模块就是特别多（有些项目模块化的程度特别高，我看过的就有asterisk和kamailio）。

所以我为此特地提供了一组性能函数族：

```c
#define lol_fatal3(d, ...)
#define lol_error3(d, ...)
#define lol_warn3(d, ...)
#define lol_info3(d, ...)
#define lol_debug3(d, ...)
#define lol_trace3(d, ...)
```

使用这组函数仅会查找一次链表，后续都会直接命中，所以性能相当高，但缺点在于域名参数无法使用变量，需要硬编码（但实际上在大多数情况下不太会影响使用），调用方式如下：

```c
// 直接传入1而非值为1的变量
lol_info3(1, "log message");
```


所以在区分域的场景下，可以尽量使用`lol_xxx3`​提高性能，如果因为调用参数的局限性，也可以退而求其次使用`lol_xxx2`​。

除此之外，为了方便某些更简单的场景（比如压根不划分域），我还提供了不需要任何域名作为参数的`lol_xxx`​函数族，在此情况下，内部会使用第一个域（第一次初始化时指定）。

由于第一个域有其特殊性，所以你初始化时甚至连域名参数都可以不带：

```c
lol_init2(); // equivalent to `lol_init(NULL, LOL_INFO, NULL, LOL_NONE);`

// 最简单的使用场景
lol_fatal("fatal");
lol_error("error");
lol_warn("warn");
lol_info("info");
lol_debug("debug");
lol_trace("trace");

lol_fini();
```

# 成品

目前最新的版本托管在[github](https://github.com/Crazyokd/lol)，大家有机会/有需求尽可以试试。
